---
title: "Analyse de prénoms"
subtitle: "Rendez-vous analytique 2022"
author: "J.P. Le Cavalier"
date: "2 juin 2022"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [xaringan-themer.css, extra.css]
    nature:
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: false
---
class: inverse center middle

```{r setup, include=FALSE}
library(knitr)
library(xaringanthemer)
library(ggplot2)
library(patchwork)
library(extrafont)
library(scales)
library(data.table)
library(stringi)
library(stringr)
library(stringdist)
library(fontawesome)

set.seed(20220602L)

options(htmltools.dir.version = FALSE)
opts_chunk$set(
  echo = FALSE,
  fig.path = "img/",
  fig.width = 15,
  fig.height = 100/15,
  fig.retina = 3,
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  fig.showtext = FALSE,
  fig.align = "center",
  hiline = TRUE
)

style_duo(
  primary_color = "#53565A",
  secondary_color = "#FDDB00",
  title_slide_background_image = "logo.svg",
  title_slide_background_size = "320px",
  title_slide_background_position = "10% 90%",
  text_font_google = google_font("Roboto"),
  header_font_google = google_font("Roboto Condensed")
)

theme_set(
  theme_minimal(
    base_size = 12L,
    base_family = gsub("'", '', theme_xaringan_get_value("text_font_family"))
  ) +
    theme(
      text = element_text(
        color = theme_xaringan_get_value("text_color")
      ),
      title = element_text(
        family = gsub("'", '', theme_xaringan_get_value("header_font_family")),
        color = theme_xaringan_get_value("header_color")
      ),
      line = element_line(
        color = lighten_color(theme_xaringan_get_value("background_color"), 0.1)
      ),
      plot.background = element_rect(
        color = NA,
        fill = theme_xaringan_get_value("background_color")
      ),
      plot.margin = margin(10, 10, 10, 10),
      plot.title = element_text(
        size = rel(1.5),
        hjust = 0.5,
        margin = margin(0, 0, 20, 0)
      ),
      strip.text = element_text(
        family = gsub("'", '', theme_xaringan_get_value("header_font_family")),
        color = theme_xaringan_get_value("header_color")
      ),
      axis.text = NULL,
      panel.grid = NULL,
      legend.position = "bottom"
    )
)

update_geom_defaults("text", list(
  family = theme_get()$text$family
))
update_geom_defaults("label", list(
  family = theme_get()$text$family
))
update_geom_defaults("col", list(
  fill = theme_xaringan_get_value("text_bold_color")
))
update_geom_defaults("point", list(
  color = theme_xaringan_get_value("text_color"),
  shape = 21,
  size = 3
))
update_geom_defaults("line", list(
  color = theme_xaringan_get_value("text_color")
))
```

<!--  IDÉES

- Évolution des prénoms composés populaires dans le temps
- Différentes définitions de distance entre les noms
  - Similitude des lettres
  - Similitude des fréquences
- Lag France/Qc
- Expliquer le concept de moyenne mobile
- Trivia game

-->

# Pour ceux qui ne sont pas au courant...

--

# .

--

### Je deviendrai papa d'une <span style="color: deeppink;">petite fille</span> en novembre prochain!

---

## Objectifs

- Analyser les tendances de prénom au Québec;

- Développer quelques métriques d'intérêt;

--

- Aider Sarah et moi à trouver un prénom de bébé.

--

### Contraintes

Le prénom doit être...

- original, mais pas trop;

- le plus intemporel possible;

- facilement prononçable en français et en anglais;

- composé uniquement de caractères alphabétiques (aucun accent, espace, trait d'union, etc.)

---

## Données brutes

Les données de prénom à la naissance au Québec (depuis 1980) sont publiées anuellement par Retraite
Québec<sup>1, 2</sup>.

```{r load-raw-data}
qc_h <- fread("data/qc-h-1980-2021.csv")
qc_f <- fread("data/qc-f-1980-2021.csv")

fr <- fread("data/fr-2020.csv")
```

#### Extrait des données brutes pour les filles

```{r explore-raw-data}
qc_f[, .(`Prénom/Année`, `1980`, `1981`, `1982`, ` ...` = " ...", `2019`, `2020`, `2021`)]
```

.footnote[
[1] https://www.donneesquebec.ca/recherche/dataset/banque-de-prenoms-garcons

[2] https://www.donneesquebec.ca/recherche/dataset/banque-de-prenoms-filles
]

---

## Transformation des données

On transforme les données avec les manipulations suivantes :

- On combine les données garçons et filles;

- On supprime la ligne des totaux;

- On renomme les colonnes;

- On passe d'un format long à un format large.

```{r transform-data}
qc <- rbindlist(mapply(
  FUN = function(data, sex) {

    data[, `:=`(
      sex = sex
    )]

    data <- melt(
      data = data[`Prénom/Année` != "Somme:" | is.na(`Prénom/Année`)],
      id.vars = c("sex", "Prénom/Année"),
      measure.vars = as.character(1980:2021),
      variable.name = "year",
      value.name = "nb",
      variable.factor = FALSE
    )

    setnames(data, "Prénom/Année", "name")

    data[]

  },
  data = list(qc_h, qc_f),
  sex = c("M", "F"),
  SIMPLIFY = FALSE
))

# Removing raw data
rm(qc_h, qc_f)

# Setting classes
qc[, `:=`(
  sex = factor(sex, c("M", "F")),
  year = as.integer(year)
)]

# Combining duplicates
qc <- qc[, .(nb = sum(nb)), .(sex, name, year)]

# Printing data
qc[]
```

---

## Identification des incohérences dans les données

```{r data-inconsistencies-jp}
jp_var <- c("JEAN PHILIPPE", "JEAN-PHILIPPE", "J PHILIPPE", "J-PHILIPPE")

ggplot(
  data = qc[name %in% jp_var],
  mapping = aes(
    x = year,
    y = nb,
    color = name
  )
) +
  geom_line() +
  facet_wrap(
    facets = vars(sex)
  )
```

---

## Identification des incohérences dans les données (suite)

```{r data-inconsistencies-jf}
jf_var <- c("JEAN FRANCOIS", "JEAN-FRANCOIS", "J FRANCOIS", "J-FRANCOIS")

ggplot(
  data = qc[name %in% jf_var],
  mapping = aes(
    x = year,
    y = nb,
    color = name
  )
) +
  geom_line() +
  facet_wrap(
    facets = vars(sex)
  )
```

---

## Nettoyage des données

- On remplace les traits d'union par des espaces;

- On complète manuellement les noms tronqués populaires **non ambigus**;

- Exemples :
  
  - J-PHILIPPE **→** J PHILIPPE **→** JEAN PHILIPPE
  
  - P-OLIVIER **→** P OLIVIER
  
```{r clean-data}
unique(qc[str_sub(name, 2L, 2L) == " "][order(-nb), .(sex, name)])[1:20]
```
